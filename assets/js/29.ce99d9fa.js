(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{581:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://kubernetes.io/zh/docs/concepts/storage/volumes/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Kubernetes 卷（Volume）"),a("OutboundLink")],1),t._v("有很多的类型，hostPath方式只是其中一个，关于hostPath，它的定位可能还是一个比较简单的应用设计，例如demo，测试等，因为它需要在每一个node节点都要有对应的挂载目录/文件。比如在k8s集群中，Master调用nginx服务，他可能会分配到多个节点，例如有2个node节点，这次nginx服务被分配到了node2节点，如果node2节点没有建立相应的目录以及配置文件，就会映射失败，那么怎么解决这个问题？")]),t._v(" "),a("ul",[a("li",[t._v("有一个方案比较省事，用ansible自动化运维，批量建立，但是这样的话，还不如使用NFS或者gluster进行挂载，更省事；")]),t._v(" "),a("li",[t._v("第二个方案：使用scp命令，将一台机器上的文件复制到其它Node节点机器上，比较麻烦，但是用来部署demo足够了。")])]),t._v(" "),a("p",[t._v("本文使用方案二hostPath挂载nginx集群的配置文件和html目录，用来部署demo。")]),t._v(" "),a("h2",{attrs:{id:"一、建立相关的配置文件和目录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、建立相关的配置文件和目录"}},[t._v("#")]),t._v(" 一、建立相关的配置文件和目录")]),t._v(" "),a("p",[t._v("我这里使用的是nginx1.18.0版本，配置文件可以映射"),a("code",[t._v("/etc/nginx/conf.d")]),t._v("这个文件夹即可。\n在Master机器上创建文件夹 "),a("code",[t._v("/nginx/conf/conf.d")]),t._v(" 新建一个"),a("code",[t._v("default.conf")]),t._v("文件，内容如下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("server {\n    listen       80;\n    server_name  localhost;\n\n    #charset koi8-r;\n    #access_log  /var/log/nginx/host.access.log  main;\n\n    location / {\n        root   /usr/share/nginx/html;\n        index  index.html index.htm;\n    }\n  \n    location /s {\n        proxy_pass http://baidu.com;\n    }\n}\t\n")])])]),a("p",[t._v("在Master机器上创建文件夹 "),a("code",[t._v("/nginx/html")]),t._v(" 新建一个"),a("code",[t._v("index.html")]),t._v("文件，随便填点内容，作为主页文件方便测试。")]),t._v(" "),a("h2",{attrs:{id:"二、将-nginx文件夹拷贝到node机器上"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二、将-nginx文件夹拷贝到node机器上"}},[t._v("#")]),t._v(" 二、将/nginx文件夹拷贝到Node机器上")]),t._v(" "),a("p",[t._v("使用scp命令："),a("code",[t._v("scp 源路径 登录名@IP:目标路径")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -r /nginx centos@k8s-node1:/\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#scp -r /nginx centos@172.26.11.139:/")]),t._v("\n")])])]),a("p",[a("code",[t._v("-r")]),t._v("表示递归拷贝目录 ，如果遇到权限不足，可先在Node机上新建好/nginx文件夹，然后给"),a("code",[t._v("chmod 777 /nginx")]),t._v("权限，再一个一个子目录拷贝。")]),t._v(" "),a("h2",{attrs:{id:"三、声明式创建deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三、声明式创建deployment"}},[t._v("#")]),t._v(" 三、声明式创建Deployment")]),t._v(" "),a("p",[t._v("deployment.yaml:")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" apps/v1  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#api版本定义")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Deployment  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#定义资源类型为Deploymant")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#元数据定义")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("deploy  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#deployment控制器名称")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" default  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#名称空间")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#deployment控制器的规格定义")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#定义deployment副本数量为2个")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#标签选择器，定义匹配Pod的标签")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Pod的模板定义")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Pod的元数据定义")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#定义Pod的标签，和上面的标签选择器标签一致，可以多出其他标签")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("deploy\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Pod的规格定义")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("conf\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /nginx/conf/conf.d\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#type: DirectoryOrCreate")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" htmls\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /nginx/html "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#node节点的宿主机目录")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#type: DirectoryOrCreate")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#容器定义")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#容器名称")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("1.18.0  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#容器镜像")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#这个目录下的配置文件在nginx.conf中的http节点下include,所以我们只需要挂载这个目录即可")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /etc/nginx/conf.d \n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("conf\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /usr/share/nginx/html\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" htmls\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#暴露端口")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#端口名称")]),t._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n")])])]),a("p",[t._v("创建：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("kubectl apply -f deployment.yaml\n")])])]),a("p",[t._v("一些命令：")]),t._v(" "),a("blockquote",[a("p",[t._v("记不住可以通过"),a("code",[t._v("kubectl --help")]),t._v("查看命令，每一个命令下的子命令也可以这样查，如："),a("code",[t._v("kubectl rollout --help")])])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#查看Pod状态")]),t._v("\nkubectl get pods\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#查看Pod 日志")]),t._v("\nkubectl logs "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("pod name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#查看deployment状态")]),t._v("\nkubectl get deployments\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#重新启动deployment（会重新创建）")]),t._v("\nkubectl rollout restart deployment/nginx-deploy\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#进入指定pod")]),t._v("\nkubectl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("pod name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" -it "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#kubectl exec nginx-deploy-7b5bc9d54d-nrf58 -it bash")]),t._v("\n")])])]),a("h2",{attrs:{id:"四、创建service并向集群外暴露端口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#四、创建service并向集群外暴露端口"}},[t._v("#")]),t._v(" 四、创建Service并向集群外暴露端口")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" NodePort "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#使用NodePort向外暴露端口")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("deploy "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#Pod的标签")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodePort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30001")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#暴露的端口为30001")]),t._v("\n")])])]),a("h2",{attrs:{id:"五、测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#五、测试"}},[t._v("#")]),t._v(" 五、测试")]),t._v(" "),a("p",[t._v("此时可以尽情测试了，访问"),a("code",[t._v("http://MasterIP:30001")]),t._v("，"),a("code",[t._v("http://MasterIP:30001/s")]),t._v(" ,改改/nginx下的配置文件或者主页等再测试都可以了（每次改完需要scp到Node上，比较麻烦）。")]),t._v(" "),a("p",[t._v("本文参考：")]),t._v(" "),a("p",[t._v("1、https://kubernetes.io/zh/docs/concepts/storage/volumes/#hostpath")]),t._v(" "),a("p",[t._v("2、 https://blog.csdn.net/weixin_45005209/article/details/107780463")])])}),[],!1,null,null,null);s.default=e.exports}}]);