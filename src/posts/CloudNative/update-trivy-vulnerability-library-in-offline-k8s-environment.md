---
title: 'ç¦»çº¿æ›´æ–°k8sç¯å¢ƒä¸‹çš„trivyæ¼æ´åº“æ–¹æ³•'
date: 2023-09-05 13:07:20
tag:
  - trivy
  - harbor
category: äº‘åŸç”Ÿ
---

æœ¬æ–‡è®°å½•çš„æ˜¯å¦‚ä½•åœ¨ç¦»çº¿ç¯å¢ƒä¸‹å¿«é€Ÿæ›´æ–°trivy.dbï¼Œè§£å†³å›½å†…ä¸‹è½½ä¸œè¥¿ç½‘ç»œæ…¢çš„é—®é¢˜ï¼Œä»¥åŠå¦‚ä½•å°†æ–‡ä»¶æ‹·è´è¿›å®¹å™¨ã€‚è¿™ä¸¤ä¸ªå°æŠ€å·§æ¯”è¾ƒå®ç”¨ï¼Œä»¥ä¾›æœªæ¥å‚è€ƒã€‚
<!-- more -->

æœ¬æ–‡çš„åœºæ™¯æ˜¯åœ¨K8Sä¸­ä½¿ç”¨Helméƒ¨ç½²çš„Harborä»“åº“ä½¿ç”¨trivyè¿›è¡Œæ¼æ´æ‰«æï¼Œéœ€è¦æ³¨æ„æˆ‘è¿™é‡Œharborç‰ˆæœ¬æ˜¯v2.1.4ã€‚å¯¹åº”çš„trivyçš„å®¹å™¨é•œåƒæ˜¯trivy-adapter-photon:v2.1.4ï¼Œä½¿ç”¨çš„æ˜¯trivy version 1ï¼Œä½¿ç”¨çš„Trivy DB çš„æ›´æ–°æ—¥æœŸè¿˜æ˜¯2021å¹´ï¼Œæ”¯æŒçš„æœ€é«˜Trivy DB v1åªæ›´æ–°åˆ°2023-02-08ï¼Œå¯ä»¥å‚è€ƒï¼š<https://github.com/aquasecurity/trivy-db#download-the-vulnerability-database>å®˜æ–¹æ–‡æ¡£ã€‚å¦‚æœè¦æ›´æ–°åˆ°æ›´æ–°çš„trivyæ¼æ´åº“ä¼°è®¡å¾—åŒæ­¥æ›´æ–°Harboræ‰è¡Œäº†ã€‚è¿™é‡Œä»…å¯¹æˆ‘è¿™ä¸ªç‰ˆæœ¬è¿›è¡Œè®°å½•ï¼Œå³åªå°†Trivy DBæ›´æ–°åˆ°2023-02-08ã€‚


æ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://aquasecurity.github.io/trivy/)å…¶å®æ›´æ–°trivy.dbçš„æ–¹å¼å¾ˆç®€å•ï¼Œå¦‚æœèƒ½è®¿é—®å¤–ç½‘ç›´æ¥ä¸€æ¡`trivy image --download-db-only`å‘½ä»¤æå®šæˆ–è€…èƒ½æ­å»ºä¸€ä¸ªdbåº“ä¹Ÿè¡Œ`trivy image --db-repository registry.gitlab.com/gitlab-org/security-products/dependencies/trivy-db
`ã€‚å¦‚æœæ²¡æœ‰å¤–ç½‘åˆ™ç›´æ¥æ›¿æ¢`harbor-harbor-trivy-0`Podä¸­`/home/scanner/.cache/trivy/db/`ç›®å½•ä¸‹çš„trivy.dbå’Œmetadata.jsonæ–‡ä»¶å³å¯ã€‚

å¦‚æœåœ¨Trivy version 1é‡Œé¢ç›´æ¥ä½¿ç”¨Trivy DB v2åˆ™ä¼šæŠ¥é”™ï¼š

<details> <summary>the version of DB schema doesn't match. Local DB: 2, Expected: 1ï¼ˆç‚¹å‡»å±•å¼€ï¼‰</summary>
2023-09-04T09:14:54Z [INFO] [/pkg/scan/job.go:325]: registration:
2023-09-04T09:14:54Z [INFO] [/pkg/scan/job.go:336]: {
  "uuid": "145755d1-008f-11ec-9901-f6b6534433d6",
  "name": "Trivy",
  "description": "The Trivy scanner adapter",
  "url": "http://harbor-harbor-trivy:8080",
  "disabled": false,
  "is_default": true,
  "health": "healthy",
  "auth": "",
  "skip_certVerify": false,
  "use_internal_addr": true,
  "adapter": "Trivy",
  "vendor": "Aqua Security",
  "version": "v0.9.2",
  "create_time": "2021-08-19T01:45:06.323427Z",
  "update_time": "2021-08-19T01:45:06.323428Z"
}
2023-09-04T09:14:54Z [INFO] [/pkg/scan/job.go:325]: scanRequest:
2023-09-04T09:14:54Z [INFO] [/pkg/scan/job.go:336]: {
  "registry": {
    "url": "http://harbor-harbor-core:80",
    "authorization": "[HIDDEN]"
  },
  "artifact": {
    "namespace_id": 3,
    "repository": "ci/javabase",
    "tag": "",
    "digest": "sha256:6bef11801820b6ec976ab59fb474807d3c9d763613c95ede87a0e27589002c7d",
    "mime_type": "application/vnd.docker.distribution.manifest.v2+json"
  }
}
2023-09-04T09:14:54Z [INFO] [/pkg/scan/job.go:156]: Report mime types: [application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0]
2023-09-04T09:14:54Z [INFO] [/pkg/scan/job.go:202]: Get report for mime type: application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0
2023-09-04T09:14:56Z [INFO] [/pkg/scan/job.go:219]: Report with mime type application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0 is not ready yet, retry after 5 seconds
2023-09-04T09:15:01Z [ERROR] [/pkg/scan/job.go:284]: check scan report with mime type application/vnd.scanner.adapter.vuln.report.harbor+json; version=1.0: running trivy wrapper: running trivy: exit status 1: 2023-09-04T09:14:58.588Z	[31mERROR[0m	Trivy version (0.9.2) is old. Update to the latest version.
2023-09-04T09:14:58.588Z	[31mFATAL[0m	database error: the version of DB schema doesn't match. Local DB: 2, Expected: 1
: general response handler: unexpected status code: 500, expected: 200
</details>

## ä¸‹è½½DB

æ ¹æ®[å®˜æ–¹æ–‡æ¡£](https://github.com/aquasecurity/trivy-db#download-the-vulnerability-database)è¯´æ˜ï¼Œå¦‚æœæ˜¯Trivy DB V1åˆ™ç›´æ¥åœ¨[github release](https://github.com/aquasecurity/trivy-db/releases)é‡Œé¢ä¸‹è½½ï¼ŒV1çš„åº“åªæ›´æ–°åˆ°2023å¹´2æœˆï¼ŒV2åˆ™éœ€è¦é€šè¿‡[Trivy](https://aquasecurity.github.io/trivy/)Â orÂ [Oras CLI](https://oras.land/cli/)ä¸‹è½½ã€‚
Trivyï¼š

```bash
# 1. åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•
TRIVY_TEMP_DIR=$(mktemp -d)

# 2. ä½¿ç”¨ Trivy ä¸‹è½½æ¼æ´æ•°æ®åº“åˆ°ä¸´æ—¶ç›®å½•
docker run --rm -v $TRIVY_TEMP_DIR:/root/.cache/ aquasec/trivy image --download-db-only

# 3. å°†æ–‡ä»¶æ‰“åŒ…åˆ° db.tar.gz
tar -cf ./db.tar.gz -C $TRIVY_TEMP_DIR trivy/db

# 4. åˆ é™¤ä¸´æ—¶ç›®å½•
rm -rf $TRIVY_TEMP_DIR

```
Oras CLIï¼š

```bash
oras pull ghcr.io/aquasecurity/trivy-db:2
```

ä½†æ˜¯å›½å†…ä¸‹è½½éƒ½éå¸¸ä¹‹æ…¢ï¼Œè¿™é‡Œæœ‰ä¸ªå°æŠ€å·§ï¼šé€šè¿‡<https://labs.play-with-docker.com/>å’Œ<https://www.tmp.link/>è¿›è¡Œä¸‹è½½ã€‚
play-with-dockerå¯ä»¥æ¯”è¾ƒå¿«é€Ÿçš„è®¿é—®å¤–ç½‘å’Œå¯åŠ¨Dockerå®¹å™¨ï¼Œåœ¨é‡Œé¢æ‰§è¡Œä¸Šé¢çš„Trivyå‘½ä»¤å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„trivy.dbå’Œmetadata.jsonæ–‡ä»¶ï¼›
è€Œtmp.linkæ˜¯ä¸€ä¸ªä¸´æ—¶ç½‘ç›˜ï¼Œå¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨Curlè¿›è¡Œæ–‡ä»¶ä¸Šä¼ ä¸‹è½½ï¼Œå°†æ–‡ä»¶é€šè¿‡Curlä¸Šä¼ åˆ°è¿™ä¸ªç½‘ç›˜å°±å¯ä»¥åœ¨å›½å†…æ¯”è¾ƒå¿«é€Ÿåœ°ä¸‹è½½äº†ã€‚
```bash
curl -k -F "file=@/root/db.tar.gz" -F "token=xxx" -F "model=1"  -X POST "https://tmp-cli.vx-cdn.com/app/upload_cli"
```

## æ›´æ¢Trivyçš„DB

æˆ‘è¿™é‡Œæ˜¯ç›´æ¥æ›¿æ¢`harbor-harbor-trivy-0`Podä¸­`/home/scanner/.cache/trivy/db/`ç›®å½•ä¸‹çš„trivy.dbå’Œmetadata.jsonæ–‡ä»¶å³å¯ã€‚

é¦–å…ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ç›´æ¥kubectl cpå‘½ä»¤å°±è¡Œäº†ã€‚å¯æ˜¯æ— æ³•æ‰§è¡Œï¼Œå¦‚ä¸‹ï¼š
```bash
# æ‹·è´å‡ºæ¥
$ kubectl cp xxx-namespace/harbor-harbor-trivy-0:/home/scanner/.cache/trivy/db/metadata.json ./metadata.json
command terminated with exit code 126

# æ‹·è´è¿›å»
$ kubectl cp ./trivy.db xxx-namespace/harbor-harbor-trivy-0:/home/scanner/.cache/trivy/db/trivy.db
OCI runtime exec failed: exec failed: container_linux.go:346: starting container process caused "exec: \"tar\": executable file not found in $PATH": unknown
command terminated with exit code 126
```

`kubectl cp`å‘½ä»¤[ä¾èµ–tarå‘½ä»¤ï¼Œå¦‚æœå®¹å™¨æ²¡æœ‰tarå‘½ä»¤æ˜¯æ²¡æ³•æ‰§è¡Œçš„](https://stackoverflow.com/a/67088185)ã€‚è€Œåˆšå¥½trivyå®¹å™¨å¯¹åº”çš„é•œåƒtrivy-adapter-photon:v2.1.4æ²¡æœ‰tarå‘½ä»¤ã€‚

ç¬¬äºŒä¸ªå°æŠ€å·§ï¼šå¤§å¤šæ•°å®¹å™¨ä¸­éƒ½æœ‰curlå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡curlå†…éƒ¨çš„minioæ–‡ä»¶æœåŠ¡è¿›è¡Œä¸‹è½½ã€‚

```bash
### å¤‡ä»½
kubectl exec -it pod/harbor-harbor-trivy-0 -n xxx-namespace -- mv /home/scanner/.cache/trivy/db/metadata.json /home/scanner/.cache/trivy/db/metadata.json.bak2

kubectl exec -it pod/harbor-harbor-trivy-0 -n xxx-namespace -- mv /home/scanner/.cache/trivy/db/trivy.db /home/scanner/.cache/trivy/db/trivy.db.bak2  


### ä¸‹è½½æ–‡ä»¶
kubectl exec -it pod/harbor-harbor-trivy-0 -n xxx-namespace --  curl -o /home/scanner/.cache/trivy/db/metadata.json 'http://10.221.113.1:32367/minio/download/trivy/metadata.json?token=' \
  -H 'Connection: keep-alive' \
  -H 'Upgrade-Insecure-Requests: 1' \
  -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36' \
  -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9' \
  -H 'Accept-Language: zh-CN,zh;q=0.9,zh-TW;q=0.8,en-US;q=0.7,en;q=0.6' \
  -H 'Cookie: redirect_to=%252F' \
  --compressed \
  --insecure

kubectl exec -it pod/harbor-harbor-trivy-0 -n xxx-namespace --  curl -o /home/scanner/.cache/trivy/db/trivy.db 'http://10.221.113.1:32367/minio/download/trivy/trivy.db?token=' \
  -H 'Connection: keep-alive' \
  -H 'Upgrade-Insecure-Requests: 1' \
  -H 'User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36' \
  -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9' \
  -H 'Accept-Language: zh-CN,zh;q=0.9,zh-TW;q=0.8,en-US;q=0.7,en;q=0.6' \
  -H 'Cookie: redirect_to=%252F' \
  --compressed \
  --insecure
```

è¿™é‡Œè¿˜æœ‰ä¸ªå°é—®é¢˜å°±æ˜¯æˆ‘ä»¬çš„minioæœåŠ¡æ˜¯ä½¿ç”¨çš„å†…éƒ¨åŸŸåï¼Œç›´æ¥åœ¨å®¹å™¨é‡Œæ— æ³•è§£æåŸŸåä¹Ÿæ— æ³•ä¿®æ”¹hostsæ–‡ä»¶ï¼Œæ‰€ä»¥è¿™é‡ŒæŠŠminioé€šè¿‡NodePortæš´éœ²å‡ºæ¥å³å¯ã€‚å°è¯•ç›´æ¥`curl minio:9000`ä¹Ÿä¸è¡Œï¼ˆk8s service name+portï¼‰ï¼Œæ‰€ä»¥æˆ‘æ·»åŠ äº†å¾ˆå¤šHeaderæ¥æ¨¡æ‹Ÿæµè§ˆå™¨è®¿é—®ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯é€šè¿‡æµè§ˆå™¨è®¿é—®`http://10.221.113.1:32367`ä¸‹è½½æ–‡ä»¶æ—¶ï¼Œä»F12æ§åˆ¶å° Copyçš„Curlå‘½ä»¤å¾—åˆ°çš„ã€‚

## æ€»ç»“

1. Trivyçš„æ¼æ´åº“DBæ›´æ–°ç›´æ¥æ›¿æ¢æ–‡ä»¶å³å¯ï¼Œä½†éœ€è¦æ³¨æ„Trivy DB V1è¿˜æ˜¯V2ï¼›
2. æŠ€å·§ä¸€ï¼šé€šè¿‡<https://labs.play-with-docker.com/>å’Œ<https://www.tmp.link/>æ“ä½œï¼Œè§£å†³å›½å†…ä¸‹è½½æ–‡ä»¶æ…¢çš„é—®é¢˜
3. æŠ€å·§äºŒï¼šå®¹å™¨ä¸­æ²¡æœ‰tarå‘½ä»¤æ— æ³•æ‰§è¡Œkubectl cpå‘½ä»¤æ—¶ï¼Œå¯ä»¥é€šè¿‡curl ä»æ–‡ä»¶å­˜å‚¨ä¸Šä¸‹è½½/ä¸Šä¼ æ–‡ä»¶ã€‚